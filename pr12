-- @Подготовка


CREATE TABLE products (
    product_id INT PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    quantity INT NOT NULL CHECK (quantity >= 0)
);

CREATE TABLE order_history (
    log_id SERIAL PRIMARY KEY,
    product_id INT,
    quantity_changed INT,
    notes VARCHAR(255),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

INSERT INTO products (product_id, name, quantity) VALUES
(1, 'Ноутбук', 20),
(2, 'Смартфон', 50);


-- @Задание 1: Успешная продажа (COMMIT)


BEGIN;

UPDATE products
SET quantity = quantity - 5
WHERE name = 'Ноутбук';

INSERT INTO order_history (product_id, quantity_changed, notes)
VALUES (
    1,
    -5,
    'Продажа 5 ноутбуков'
);

COMMIT;

-- Проверка
SELECT * FROM products;
SELECT * FROM order_history;


-- @Задание 2: Неудачная продажа (ROLLBACK)


BEGIN;

-- Попытка уменьшить количество на складе, вызовет ошибку CHECK
UPDATE products
SET quantity = quantity - 100
WHERE name = 'Смартфон';

INSERT INTO order_history (product_id, quantity_changed, notes)
VALUES (
    2,
    -100,
    'Попытка продажи 100 смартфонов'
);

-- Транзакция автоматически отменится из-за ошибки
-- Проверка
SELECT * FROM products;
SELECT * FROM order_history;


-- @Задание 3: Ручной откат


BEGIN;

UPDATE products
SET quantity = quantity - 2
WHERE name = 'Ноутбук';

-- Бизнес-логика не прошла, откат
ROLLBACK;

-- Проверка: количество ноутбуков осталось прежним
SELECT * FROM products;


-- @Задание 4 (со звездочкой): Демонстрация уровня изоляции


-- Для выполнения этого задания нужны две сессии (окна терминала)

-- Сессия 1:
-- BEGIN;
-- UPDATE products SET quantity = quantity - 10 WHERE product_id = 2;
-- (не COMMIT пока)

-- Сессия 2 (одновременно):
-- SELECT * FROM products WHERE product_id = 2;
-- -- quantity всё ещё 50, изменения из сессии 1 не видны

-- Сессия 1:
-- COMMIT;

-- Сессия 2:
-- SELECT * FROM products WHERE product_id = 2;
-- -- теперь quantity = 40, изменения из сессии 1 зафиксированы
